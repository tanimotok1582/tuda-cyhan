<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kochi Stellar Tide - ÊÇ†‰πÖ„ÅÆÊö¶ Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@200;400&family=Lato:wght@100;300&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <style>
        :root { --bg-color: #010105; --text-color: #e6f3ff; --accent-color: #b3d9ff; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg-color); color: var(--text-color); font-family: 'Noto Serif JP', serif; overflow: hidden; }
        canvas { position: fixed; top: 0; left: 0; z-index: 1; }
        
        #content { position: relative; z-index: 2; padding: 5vh 5vw; display: flex; flex-direction: column; justify-content: space-between; height: 100vh; box-sizing: border-box; }
        
        /* „Éò„ÉÉ„ÉÄ„Éº„Ç®„É™„Ç¢ */
        .header { display: flex; justify-content: space-between; align-items: flex-start; }
        .location-info { border-left: 1px solid rgba(255,255,255,0.2); padding-left: 15px; }
        .era-title { font-size: clamp(1rem, 4vw, 1.4rem); letter-spacing: 0.2em; font-weight: 200; }
        
        /* Ê∞óË±°„ÉªÊòüÁ©∫ÊåáÊï∞ÊÉÖÂ†± */
        .weather-panel { text-align: right; font-family: 'Lato', sans-serif; }
        .index-value { font-size: 2rem; font-weight: 100; color: var(--accent-color); }
        .index-label { font-size: 0.6rem; letter-spacing: 0.2em; opacity: 0.6; }

        /* „É°„Ç§„É≥Ë°®Á§∫ */
        .main-display { max-width: 800px; cursor: pointer; transition: 0.4s; }
        .astro-label { font-size: 0.7rem; letter-spacing: 0.5em; color: var(--accent-color); margin-bottom: 15px; display: block; }
        #astro-title { font-size: clamp(2rem, 8vw, 3.5rem); margin: 0; font-weight: 200; line-height: 1.2; }
        #astro-sub { font-size: clamp(0.9rem, 3vw, 1.05rem); opacity: 0.8; margin-top: 20px; line-height: 1.8; max-width: 500px; }

        /* „Éï„ÉÉ„Çø„Éº */
        .footer { font-family: 'Lato'; font-size: 0.6rem; opacity: 0.4; letter-spacing: 0.2em; display: flex; justify-content: space-between; align-items: center; }
        
        /* „É¢„Éº„ÉÄ„É´ */
        #modal { display: none; position: fixed; z-index: 100; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); justify-content: center; align-items: center; }
        #modal.show { display: flex; }
        .modal-body { max-width: 90%; width: 450px; padding: 40px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.02); }

        @media (max-width: 600px) {
            #content { padding: 8vh 8vw; }
            .header { flex-direction: column; gap: 20px; }
        }
    </style>
</head>
<body>
    <canvas id="sky-canvas"></canvas>
    
    <div id="content">
        <div class="header">
            <div class="location-info">
                <div class="era-title" id="era-display"></div>
                <div style="font-size: 0.8rem; opacity: 0.6; margin-top: 5px;">
                    <span id="lunar-icon"></span> <span id="lunar-name"></span> (<span id="lunar-age"></span>)
                </div>
            </div>
            <div class="weather-panel">
                <div class="index-label">STARGAZING INDEX</div>
                <div class="index-value" id="star-index">--</div>
                <div id="weather-desc" style="font-size: 0.7rem; opacity: 0.7;">Fetching sky...</div>
            </div>
        </div>

        <div class="main-display" id="trigger-modal">
            <span class="astro-label">TONIGHT'S STELLAR STORY</span>
            <h1 id="astro-title">Loading...</h1>
            <p id="astro-sub"></p>
        </div>

        <div class="footer">
            <div>KOCHI / 33.5597¬∞ N, 133.5311¬∞ E</div>
            <div id="digital-clock">00:00:00</div>
        </div>
    </div>

    <div id="modal">
        <div class="modal-body">
            <h2 id="modal-title" style="font-weight: 200; font-size: 1.8rem;"></h2>
            <p id="modal-desc" style="line-height: 2; opacity: 0.8; margin-top: 20px;"></p>
            <div id="close-modal" style="cursor:pointer; margin-top:30px; text-align:right; font-size:0.7rem; opacity:0.5;">CLOSE [√ó]</div>
        </div>
    </div>

    <script>
        // --- Ë®≠ÂÆö„Éª„Éá„Éº„Çø ---
        const KOCHI_COORDS = { lat: 33.5597, lon: 133.5311 };
        const API_KEY = 'YOUR_OPENWEATHER_API_KEY'; // „Åì„Åì„Å´API„Ç≠„Éº„ÇíÂÖ•„Çå„Çã„Å®ÂÆüÁ®ºÂÉç„Åó„Åæ„Åô
        
        const ASTRO_CATALOG = {
            "02-04": { title: "Á´ãÊò•„ÅÆÊòéÊòü", desc: "Êö¶„ÅåÊò•„Å∏„Å®Âàá„ÇäÊõø„Çè„Çã‰ªäÂ§ú„ÄÇÈ´òÁü•„ÅÆÁ©∫„Å´„ÅØ„ÄÅÊñ∞„Åó„ÅÑÂ≠£ÁØÄ„ÅÆÂßã„Åæ„Çä„ÇíÂëä„Åí„ÇãÈáëÊòü„ÅåËºù„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÄÇÂ§™Âπ≥Ê¥ã„Åã„ÇâÂêπ„ÅçËæº„ÇÄÈ¢®„ÇÇ„ÄÅ„Å©„Åì„ÅãÊüî„Çâ„Åã„Å™Ë≥™ÊÑü„ÇíÂê´„ÅøÂßã„ÇÅ„Åæ„Åô„ÄÇ" },
            "default": { title: "Âúü‰Ωê„ÅÆÊ∑±Ê∑µ„Å™„ÇãÊòüÁ©∫", desc: "Èè°Â∑ù„ÅÆ„Åõ„Åõ„Çâ„Åé„ÄÅ„ÅÇ„Çã„ÅÑ„ÅØÂ§™Âπ≥Ê¥ã„ÅÆÊ≥¢Èü≥„ÄÇÈ´òÁü•„ÅÆÂ§ú„ÇíÂΩ©„ÇãÁÑ°Êï∞„ÅÆÊòü„ÄÖ„ÅØ„ÄÅÊôÇ‰ª£„ÇíË∂Ö„Åà„Å¶Âêå„ÅòÂÖâ„ÇíÂ±ä„Åë„Å¶„ÅÑ„Åæ„Åô„ÄÇ" }
        };

        // --- Â§©Êñá„ÉªÊ∞óË±°„É≠„Ç∏„ÉÉ„ÇØ ---
        async function updateEnvironment() {
            const now = new Date();
            
            // 1. Á≤æÂØÜ„Å™ÊúàÈΩ¢Ë®àÁÆó (SunCalc‰ΩøÁî®)
            const moonIllum = SunCalc.getMoonIllumination(now);
            const moonAge = Math.floor(moonIllum.phase * 29.53);
            const moonIcons = ["üåë","üåí","üåì","üåî","üåï","üåñ","üåó","üåò"];
            const iconIdx = Math.floor(moonIllum.phase * 8) % 8;
            
            document.getElementById('lunar-icon').innerText = moonIcons[iconIdx];
            document.getElementById('lunar-age').innerText = `ÊúàÈΩ¢ ${moonAge.toFixed(1)}`;

            // 2. Ê∞óË±°„Éá„Éº„Çø„ÅÆÂèñÂæó (Mock„Éá„Éº„Çø or API)
            // ÂÆüÈöõ„ÅØ fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${KOCHI_COORDS.lat}&lon=${KOCHI_COORDS.lon}&appid=${API_KEY}&units=metric&lang=ja`)
            const weatherData = {
                clouds: 10, // Èõ≤Èáè %
                humidity: 45, // ÊπøÂ∫¶ %
                wind: 2.5,   // È¢®ÈÄü m/s
                desc: "Âø´Êô¥"
            };

            // 3. ÊòüÁ©∫ÊåáÊï∞„ÅÆË®àÁÆó (Áã¨Ëá™„É≠„Ç∏„ÉÉ„ÇØ)
            // Èõ≤„ÅåÂ∞ë„Å™„Åè„ÄÅÊπøÂ∫¶„Åå‰Ωé„ÅÑ„Åª„Å©È´ò„Çπ„Ç≥„Ç¢
            let starIndex = Math.max(0, 100 - (weatherData.clouds * 0.8) - (weatherData.humidity * 0.2));
            document.getElementById('star-index').innerText = Math.floor(starIndex);
            document.getElementById('weather-desc').innerText = `Èõ≤Èáè ${weatherData.clouds}% / ${weatherData.desc}`;

            // 4. „Ç≥„É≥„ÉÜ„É≥„ÉÑÊõ¥Êñ∞
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            const info = ASTRO_CATALOG[`${m}-${d}`] || ASTRO_CATALOG["default"];
            
            document.getElementById('astro-title').innerText = info.title;
            document.getElementById('astro-sub').innerText = info.desc;
            document.getElementById('modal-title').innerText = info.title;
            document.getElementById('modal-desc').innerText = info.desc;

            // ÂíåÊö¶Ë°®Á§∫
            const era = new Intl.DateTimeFormat('ja-JP-u-ca-japanese', { era: 'long', year: 'numeric', month: 'long', day: 'numeric' }).format(now);
            document.getElementById('era-display').innerText = era;
        }

        // --- „Éì„Ç∏„É•„Ç¢„É´ÊºîÂá∫ (Canvas) ---
        const canvas = document.getElementById('sky-canvas');
        const ctx = canvas.getContext('2d');
        let stars = [];

        function initSky() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            stars = Array.from({length: 300}, () => ({
                x: Math.random()*canvas.width, y: Math.random()*canvas.height,
                size: Math.random()*1.5, opacity: Math.random(),
                blink: Math.random()*0.01 + 0.005
            }));
        }

        function draw() {
            ctx.fillStyle = '#010105';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            stars.forEach(s => {
                s.opacity += s.blink;
                if(s.opacity > 1 || s.opacity < 0.2) s.blink *= -1;
                ctx.globalAlpha = s.opacity;
                ctx.fillStyle = "#ffffff";
                ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill();
            });
            requestAnimationFrame(draw);
        }

        // --- „Ç™„Éº„Éá„Ç£„Ç™ (Web Audio API) ---
        let audioCtx;
        function playOcean() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const playWave = () => {
                const node = audioCtx.createBufferSource();
                const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 5, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1;
                node.buffer = buffer;
                const gain = audioCtx.createGain();
                const filter = audioCtx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(400, audioCtx.currentTime);
                filter.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 2.5);
                gain.gain.setValueAtTime(0, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0.05, audioCtx.currentTime + 2.5);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 5);
                node.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
                node.start();
            };
            setInterval(playWave, 6000); playWave();
        }

        // --- ÂàùÊúüÂåñ & „Ç§„Éô„É≥„Éà ---
        window.addEventListener('resize', initSky);
        document.getElementById('trigger-modal').onclick = () => {
            document.getElementById('modal').classList.add('show');
            playOcean();
        };
        document.getElementById('close-modal').onclick = () => document.getElementById('modal').classList.remove('show');

        setInterval(() => {
            document.getElementById('digital-clock').innerText = new Date().toLocaleTimeString('ja-JP', {hour12:false});
        }, 1000);

        initSky(); draw(); updateEnvironment();
    </script>
</body>
</html>
