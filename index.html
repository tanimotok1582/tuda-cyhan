<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kochi Stellar Tide - ÊÇ†‰πÖ„ÅÆÊö¶ Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@200&family=Lato:wght@100&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <style>
        :root { 
            --bg-color: #010105; 
            --text-color: #e6f3ff; 
            --accent-color: #b3d9ff; 
            --clock-color: #ffffff;
            --transition-smooth: 1.2s cubic-bezier(0.2, 1, 0.3, 1);
        }

        * {
            font-family: 'Noto Serif JP', serif;
            font-weight: 200;
            -webkit-font-smoothing: antialiased;
        }

        .footer, #digital-clock, #koki-display {
            font-family: 'Lato', 'Noto Serif JP', serif;
        }
        
        #lunar-icon {
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg-color); color: var(--text-color); 
            overflow: hidden; 
        }

        canvas { position: fixed; top: 0; left: 0; z-index: 1; pointer-events: none; }
        
        #content { 
            position: relative; z-index: 2; padding: 5vh 5vw; 
            display: flex; flex-direction: column; justify-content: space-between; 
            height: 100vh; box-sizing: border-box; pointer-events: none; 
        }
        
        .header, .main-display, .footer { pointer-events: auto; }

        /* Â∑¶‰∏ä„ÅÆÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥ */
        .location-info { border-left: 1px solid rgba(255,255,255,0.2); padding-left: 15px; }
        .era-title { font-size: clamp(1rem, 4vw, 1.4rem); letter-spacing: 0.3em; margin-bottom: 5px; }
        .koki-label { font-size: 0.8rem; opacity: 0.6; letter-spacing: 0.1em; }

        .main-display { 
            max-width: 800px; cursor: pointer; transition: var(--transition-smooth); 
            background: none; border: none; text-align: left; color: inherit; padding: 0;
            outline: none;
        }
        .main-display:hover { transform: translateX(10px); opacity: 0.7; }

        .astro-label { font-size: 0.7rem; letter-spacing: 0.5em; color: var(--accent-color); margin-bottom: 15px; display: block; opacity: 0.8; }
        #astro-title { font-size: clamp(2rem, 8vw, 3.5rem); margin: 0; line-height: 1.4; letter-spacing: 0.1em; }
        #astro-sub { font-size: clamp(0.85rem, 2.5vw, 1rem); opacity: 0.7; margin-top: 25px; line-height: 2.5; max-width: 550px; }

        .footer { font-size: 0.7rem; opacity: 0.6; letter-spacing: 0.2em; display: flex; justify-content: space-between; align-items: center; }
        #digital-clock { 
            font-size: 0.9rem; 
            color: var(--clock-color); 
            opacity: 0.9; 
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.3); 
            letter-spacing: 0.1em;
        }

        #modal { 
            display: none; position: fixed; z-index: 100; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            justify-content: center; align-items: center; 
            opacity: 0; 
            transition: opacity 0.8s ease;
        }
        #modal.show { display: flex; opacity: 1; pointer-events: auto; }
        
        .modal-body { 
            max-width: 90%; width: 520px; padding: 60px; 
            border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.02); 
            transform: scale(0.98) translateY(10px); transition: var(--transition-smooth);
        }
        #modal.show .modal-body { transform: scale(1) translateY(0); }
        .close-btn { background: none; border: none; color: var(--text-color); cursor: pointer; width: 100%; text-align: right; margin-top: 40px; font-size: 0.7rem; opacity: 0.5; letter-spacing: 0.2em; }
    </style>
</head>
<body>
    <canvas id="sky-canvas"></canvas>
    
    <main id="content">
        <header class="header">
            <div class="location-info">
                <div class="era-title" id="era-display">--</div>
                <div class="koki-label">ÁöáÁ¥Ä <span id="koki-year">----</span> Âπ¥</div>
                <div style="font-size: 0.8rem; opacity: 0.6; margin-top: 12px;">
                    <span id="lunar-icon" aria-hidden="true"></span> <span id="lunar-status">Ë®àÁÆó‰∏≠...</span>
                </div>
            </div>
        </header>

        <button class="main-display" id="trigger-modal">
            <span class="astro-label">TONIGHT'S STELLAR STORY</span>
            <h1 id="astro-title">È´òÁü•„ÅÆÊòüÁ©∫</h1>
            <p id="astro-sub">Ë™≠„ÅøËæº„Åø‰∏≠...</p>
            <div style="margin-top: 40px; font-size: 0.65rem; letter-spacing: 0.3em; opacity: 0.3;">Tosa Bay Whispers - Tap to Listen</div>
        </button>

        <footer class="footer">
            <div>KOCHI / 33.55¬∞ N, 133.53¬∞ E</div>
            <div id="digital-clock">00:00:00</div>
        </footer>
    </main>

    <div id="modal" role="dialog" aria-modal="true">
        <div class="modal-body">
            <h2 id="modal-title" style="font-size: 2rem; margin-bottom: 25px;"></h2>
            <p id="modal-desc" style="line-height: 2.8; opacity: 0.9;"></p>
            <button class="close-btn" id="close-modal">Èñâ„Åò„Çã [√ó]</button>
        </div>
    </div>

    <script>
        const CONFIG = {
            coords: { lat: 33.5597, lon: 133.5311 },
            astroData: {
                "02-04": { title: "Á´ãÊò•„ÅÆÊòéÊòü", desc: "Êö¶„ÅåÊò•„Å∏„Å®Âàá„ÇäÊõø„Çè„Çã‰ªäÂ§ú„ÄÇÈ´òÁü•„ÅÆÁ©∫„Å´„ÅØ„ÄÅÊñ∞„Åó„ÅÑÂ≠£ÁØÄ„ÅÆÂßã„Åæ„Çä„ÇíÂëä„Åí„ÇãÊòéÊòü„ÅåËºù„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÄÇÂ§™Âπ≥Ê¥ã„Åã„ÇâÂêπ„ÅçËæº„ÇÄÈ¢®„ÇÇ„ÄÅ„Å©„Åì„ÅãÊüî„Çâ„Åã„Å™Ë≥™ÊÑü„ÇíÂê´„ÅøÂßã„ÇÅ„Åæ„Åô„ÄÇ" },
                "default": { title: "Âúü‰Ωê„ÅÆÊ∑±Ê∑µ„Å™„ÇãÊòüÁ©∫", desc: "Èè°Â∑ù„ÅÆ„Åõ„Åõ„Çâ„Åé„ÄÅ„ÅÇ„Çã„ÅÑ„ÅØÂ§™Âπ≥Ê¥ã„ÅÆÊ≥¢Èü≥„ÄÇÈ´òÁü•„ÅÆÂ§ú„ÇíÂΩ©„ÇãÁÑ°Êï∞„ÅÆÊòü„ÄÖ„ÅØ„ÄÅÊôÇ‰ª£„ÇíË∂Ö„Åà„Å¶Âêå„ÅòÂÖâ„ÇíÂ±ä„Åë„Å¶„ÅÑ„Åæ„Åô„ÄÇ" }
            }
        };

        const state = { timers: [], audioCtx: null };

        function updateEnvironment() {
            const now = new Date();
            
            // ÂíåÊö¶„ÅÆÂèñÂæó
            const era = new Intl.DateTimeFormat('ja-JP-u-ca-japanese', { era: 'long', year: 'numeric', month: 'long', day: 'numeric' }).format(now);
            document.getElementById('era-display').innerText = era;

            // ÁöáÁ¥Ä„ÅÆË®àÁÆó (Ë•øÊö¶ + 660)
            const kokiYear = now.getFullYear() + 660;
            document.getElementById('koki-year').innerText = kokiYear;

            // ÁèæÂÆü„ÅÆÊúàÈΩ¢Ë®àÁÆó (È´òÁü•„ÅÆÂ∫ßÊ®ô„Å´Âü∫„Å•„ÅÑ„Åü„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥)
            try {
                const moon = SunCalc.getMoonIllumination(now);
                const moonIcons = ["üåë","üåí","üåì","üåî","üåï","üåñ","üåó","üåò"];
                document.getElementById('lunar-icon').innerText = moonIcons[Math.floor(moon.phase * 8) % 8];
                document.getElementById('lunar-status').innerText = `ÊúàÈΩ¢ ${(moon.phase * 29.5).toFixed(1)}`;
            } catch (e) {}

            const key = `${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
            const info = CONFIG.astroData[key] || CONFIG.astroData.default;
            document.getElementById('astro-title').innerText = info.title;
            document.getElementById('astro-sub').innerText = info.desc;
            document.getElementById('modal-title').innerText = info.title;
            document.getElementById('modal-desc').innerText = info.desc;
        }

        // --- Ë¶ñË¶öÊºîÂá∫ (Canvas & Animation) ---
        const canvas = document.getElementById('sky-canvas');
        const ctx = canvas.getContext('2d');
        let stars = [], shootingStars = [];

        function initSky() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            stars = Array.from({length: 300}, () => ({
                x: Math.random() * canvas.width, y: Math.random() * canvas.height,
                size: Math.random() * 1.1, opacity: Math.random(), blink: Math.random() * 0.008 + 0.003
            }));
        }

        function createShootingStar() {
            shootingStars.push({
                x: Math.random() * canvas.width, y: Math.random() * canvas.height * 0.5,
                len: Math.random() * 120 + 60, speed: Math.random() * 10 + 10,
                opacity: 1, angle: Math.PI / 4 + (Math.random() - 0.5) * 0.1
            });
        }

        function draw() {
            ctx.fillStyle = '#010105'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            stars.forEach(s => {
                s.opacity += s.blink; if(s.opacity > 1 || s.opacity < 0.2) s.blink *= -1;
                ctx.globalAlpha = s.opacity; ctx.fillStyle = "#ffffff";
                ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill();
            });
            ctx.globalAlpha = 1.0;
            shootingStars.forEach((ss, i) => {
                ctx.strokeStyle = `rgba(255, 255, 255, ${ss.opacity})`; ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(ss.x, ss.y);
                ctx.lineTo(ss.x + Math.cos(ss.angle)*ss.len, ss.y + Math.sin(ss.angle)*ss.len); ctx.stroke();
                ss.x += Math.cos(ss.angle) * ss.speed; ss.y += Math.sin(ss.angle) * ss.speed;
                ss.opacity -= 0.02; if(ss.opacity <= 0) shootingStars.splice(i, 1);
            });
            requestAnimationFrame(draw);
        }

        // --- „Ç™„Éº„Éá„Ç£„Ç™ÊºîÂá∫ ---
        function playOcean() {
            if (state.audioCtx) return;
            state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const sweep = () => {
                const node = state.audioCtx.createBufferSource();
                const buffer = state.audioCtx.createBuffer(1, state.audioCtx.sampleRate * 8, state.audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1;
                node.buffer = buffer;
                const gain = state.audioCtx.createGain();
                const filter = state.audioCtx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(300, state.audioCtx.currentTime);
                filter.frequency.exponentialRampToValueAtTime(1000, state.audioCtx.currentTime + 4);
                gain.gain.setValueAtTime(0, state.audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0.04, state.audioCtx.currentTime + 4);
                gain.gain.linearRampToValueAtTime(0, state.audioCtx.currentTime + 8);
                node.connect(filter); filter.connect(gain); gain.connect(state.audioCtx.destination);
                node.start();
            };
            setInterval(sweep, 9000); sweep();
        }

        // --- „Ç§„Éô„É≥„ÉàÁÆ°ÁêÜ ---
        document.getElementById('trigger-modal').onclick = () => {
            document.getElementById('modal').style.display = 'flex';
            setTimeout(() => document.getElementById('modal').classList.add('show'), 10);
            playOcean();
        };
        document.getElementById('close-modal').onclick = () => {
            document.getElementById('modal').classList.remove('show');
            setTimeout(() => document.getElementById('modal').style.display = 'none', 800);
        };
        
        window.addEventListener('resize', initSky);
        setInterval(() => {
            document.getElementById('digital-clock').innerText = new Date().toLocaleTimeString('ja-JP', {hour12:false});
        }, 1000);
        setInterval(createShootingStar, 8000);

        initSky(); draw(); updateEnvironment();
    </script>
</body>
</html>
